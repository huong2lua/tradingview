//@version=6
indicator('MACD 4C (Pro) ‚Äî Lot theo tick + L·ªçc t√≠n hi·ªáu', shorttitle='MACD4C Pro', format=format.price, precision=2)

// =====================
// 1) INPUTS / THAM S·ªê
// =====================

// --- MACD & ATR
fastMA    = input.int(12,  'Fast MA', minval=1)
slowMA    = input.int(26,  'Slow MA', minval=1)
sigMA     = input.int(9,   'Signal MA', minval=1)
atrLength = input.int(14,  'ATR Length', minval=1)
atrMult   = input.float(1.5, 'ATR Multiplier (cho SL)', step=0.1)

// --- TP/SL & Risk
rrRatio   = input.float(2.0, 'Risk:Reward Ratio (TP/SL)', step=0.1)
riskUSD   = input.float(20,  'M·ª©c r·ªßi ro m·ªói l·ªánh (USD)', step=1.0)

// --- V√πng swing ƒë·ªÉ ƒë·∫∑t SL (thay cho c·ªë ƒë·ªãnh 9)
swingLen  = input.int(9, 'ƒê·ªô d√†i swing (lowest/highest) cho SL', minval=1)

// --- Lot theo tick (T·ªîNG QU√ÅT, kh√¥ng c·∫ßn bi·∫øt pip c·ªßa t·ª´ng s·∫£n ph·∫©m)
//     tick = b∆∞·ªõc nh·∫£y nh·ªè nh·∫•t c·ªßa symbol (syminfo.mintick)
//     B·∫°n ƒëi·ªÅn ƒë√∫ng "USD/tick/lot" theo s·∫£n ph·∫©m/broker c·ªßa b·∫°n.
//     V√≠ d·ª•: N·∫øu m·ªói tick c·ªßa 1 lot tr·ªã gi√° 1 USD -> nh·∫≠p 1.0
//            N·∫øu m·ªói tick c·ªßa 1 lot tr·ªã gi√° 10 USD -> nh·∫≠p 10.0
tickValuePerLot = input.float(10.0, 'Gi√° tr·ªã m·ªói tick cho 1 lot (USD/tick/lot)', step=0.01, minval=0.0001)

// --- L·ªçc t√≠n hi·ªáu (tu·ª≥ ch·ªçn, ƒë·ªÉ gi·∫£m nhi·ªÖu)
useSignalConfirm = input.bool(true,  'B·∫≠t l·ªçc: MACD line ph·∫£i c√πng ph√≠a v·ªõi Signal (mua: MACD>Signal, b√°n: MACD<Signal)')
useZeroFilter    = input.bool(false, 'B·∫≠t l·ªçc: Zero-line (mua khi hist>0, b√°n khi hist<0)')
minHistAbs       = input.float(0.0,  'Ng∆∞·ª°ng |Histogram| t·ªëi thi·ªÉu (0 = t·∫Øt)', step=0.0001, minval=0.0)

// --- Webhook/Telegram
chatId    = input.string("5978153872", "Telegram chat_id (tu·ª≥ ch·ªçn)")
// L∆∞u √Ω: URL webhook ƒë∆∞·ª£c c√†i trong c·ª≠a s·ªï Alert c·ªßa TradingView, kh√¥ng code trong script.

// =============================================
// 2) T√çNH MACD & D√ôNG HISTOGRAM TH·∫¨T CHO 4 M√ÄU
// =============================================
[macdLine, signalLine, _] = ta.macd(close, fastMA, slowMA, 9)
currMacd = macdLine
prevMacd = macdLine[1]

// M√†u 4 tr·∫°ng th√°i:
//  - >0 & tƒÉng   : xanh s√°ng (up strong)
//  - >0 & gi·∫£m   : xanh ƒë·∫≠m  (up weak)
//  - <0 & tƒÉng   : ƒë·ªè n√¢u     (down weak)
//  - <0 & gi·∫£m   : ƒë·ªè t∆∞∆°i    (down strong)
isUpStrong   = currMacd > 0 and currMacd > prevMacd
isUpWeak     = currMacd > 0 and currMacd <= prevMacd
isDownWeak   = currMacd <= 0 and currMacd >= prevMacd
isDownStrong = currMacd < 0 and currMacd < prevMacd

plotColor = currMacd > 0 ? currMacd > prevMacd ? color.new(color.rgb(0, 255, 0), 35) : color.new(color.rgb(0, 128, 0), 35) : currMacd < prevMacd ? color.new(color.rgb(128, 0, 0), 35) : color.new(color.rgb(255, 0, 0), 35)


// V·∫Ω Histogram + zero-line
plot(currMacd, style=plot.style_histogram, color=plotColor, linewidth=3, title='MACD Histogram')
plot(0, title='Zero Line', linewidth=1, color=color.gray)

// ƒê·ªïi nh√≥m m√†u so v·ªõi bar tr∆∞·ªõc? (ƒë·ªÉ ch·∫∑n spam khi m√†u kh√¥ng ƒë·ªïi)
colorChanged = (isUpStrong and not isUpStrong[1]) or
               (isUpWeak and not isUpWeak[1]) or
               (isDownWeak and not isDownWeak[1]) or
               (isDownStrong and not isDownStrong[1])

// ==================================
// 3) T√çN HI·ªÜU G·ªêC + B·ªò L·ªåC TU·ª≤ CH·ªåN
// ==================================

// T√≠n hi·ªáu g·ªëc gi·ªëng b·∫£n c·ªßa b·∫°n:
isBuyRaw  = isUpStrong or isDownWeak    // mua: l·ª±c mua m·∫°nh ho·∫∑c b√°n y·∫øu
isSellRaw = isDownStrong or isUpWeak    // b√°n: l·ª±c b√°n m·∫°nh ho·∫∑c mua y·∫øu

// B·ªô l·ªçc 1: MACD line c√πng ph√≠a v·ªõi Signal? (kh√¥ng c·∫ßn c·∫Øt, ch·ªâ c·∫ßn ·ªü c√πng ph√≠a ƒë·ªÉ gi·∫£m nhi·ªÖu)
signalAgreeBuy  = macdLine > signalLine
signalAgreeSell = macdLine < signalLine
passSignalAgree = not useSignalConfirm or (isBuyRaw and signalAgreeBuy) or (isSellRaw and signalAgreeSell)

// B·ªô l·ªçc 2: Zero-line (hist > 0 cho Buy, < 0 cho Sell)
passZero = not useZeroFilter or (isBuyRaw and currMacd > 0) or (isSellRaw and currMacd < 0)

// B·ªô l·ªçc 3: Ng∆∞·ª°ng t·ªëi thi·ªÉu |hist|
passMinHist = (minHistAbs <= 0.0) or (math.abs(currMacd) >= minHistAbs)

// T√≠n hi·ªáu sau l·ªçc:
isBuySignal  = isBuyRaw  and passSignalAgree and passZero and passMinHist
isSellSignal = isSellRaw and passSignalAgree and passZero and passMinHist

// ===============================
// 4) ATR + SL/TP + KH·ªêI L∆Ø·ª¢NG LOT
// ===============================

// ATR & v√πng swing
atrValue = ta.atr(atrLength)
lowestSw  = ta.lowest(low,  swingLen)
highestSw = ta.highest(high, swingLen)
currPrice = close

// SL/TP theo h∆∞·ªõng
slBuy  = lowestSw  - atrValue * atrMult
slSell = highestSw + atrValue * atrMult
tpBuy  = currPrice + (currPrice - slBuy)   * rrRatio
tpSell = currPrice - (slSell   - currPrice)* rrRatio

// Kho·∫£ng c√°ch t·ªõi SL (ƒë∆°n v·ªã GI√Å)
slDistance =
     isBuySignal  ? (currPrice - slBuy)  :
     isSellSignal ? (slSell - currPrice) :
     na

// Chuy·ªÉn sang s·ªë TICK t·ªõi SL ƒë·ªÉ t√≠nh ti·ªÅn r·ªßi ro chu·∫©n m·ªçi s·∫£n ph·∫©m
ticksToSL = na(slDistance) ? na : slDistance / syminfo.mintick

// Lot size (USD r·ªßi ro / (ticks * USD/tick/lot))
// Guard: n·∫øu kh√¥ng c√≥ t√≠n hi·ªáu, ho·∫∑c ticks<=0, s·∫Ω ra na
lotSize = na(ticksToSL) or (ticksToSL <= 0) ? na : (riskUSD / (ticksToSL * tickValuePerLot))

// =======================
// 5) ALERT + WEBHOOK JSON
// =======================

// Ch·ªâ alert khi ƒë·ªïi m√†u V√Ä t√≠n hi·ªáu qua l·ªçc V√Ä n·∫øn ƒë√£ ƒë√≥ng (tr√°nh repaint)
finalSignal = (isBuySignal or isSellSignal)
alertOnClose = colorChanged and finalSignal and barstate.isconfirmed

if alertOnClose
    // G·∫Øn nh√£n tr·∫°ng th√°i & h∆∞·ªõng
    trendType = isUpStrong ? "mua m·∫°nh üü¢" : isUpWeak ? "mua y·∫øu üìà" : isDownWeak ? "b√°n y·∫øu üü†" : isDownStrong ? "b√°n m·∫°nh üîª" : "kh√¥ng x√°c ƒë·ªãnh ‚ùì"
    signalType = isBuySignal ? "BUY üü©" : isSellSignal ? "SELL üü•" : "NO ‚ùì"

    slValue = isBuySignal  ? slBuy  : isSellSignal ? slSell : na
    tpValue = isBuySignal  ? tpBuy  : isSellSignal ? tpSell : na

    // Kh√¥ng √©p "m" v√†o timeframe -> d√πng tr·ª±c ti·∫øp ƒë·ªÉ h·ª£p m·ªçi khung (1, 5, 1D, 1W, ...)
    tfLabel = timeframe.period

    // T·∫°o message hi·ªÉn th·ªã
    msg =
      "#" + syminfo.ticker + "m " + tfLabel + " l·ª±c " + trendType + " ‚îÇ " + signalType + " ‚îÇ " +
      "Entry: " + str.tostring(currPrice, format.mintick) + " ‚îÇ " +
      "SL: "    + str.tostring(slValue,   format.mintick) + " ‚îÇ " +
      "TP: "    + str.tostring(tpValue,   format.mintick) + " ‚îÇ " +
      "Lot: "   + (na(lotSize) ? "n/a" : str.tostring(lotSize, "#.###"))

    // Escape d·∫•u ngo·∫∑c k√©p ƒë·ªÉ JSON kh√¥ng l·ªói
    safeMsg = str.replace(msg, '"', '\\"')

    // Payload g·ª≠i Telegram (URL webhook c√†i trong Alert c·ªßa TradingView)
    alertMessage = '{"chat_id":"' + chatId + '","text":"' + safeMsg + '"}'

    // G·ª≠i 1 l·∫ßn khi n·∫øn ƒë√≥ng
    alert(alertMessage, freq=alert.freq_once_per_bar_close)

// T·∫°o ƒëi·ªÅu ki·ªán cho c·ª≠a s·ªï Alerts (message m·∫´u ‚Äî b·∫°n c√≥ th·ªÉ thay)
alertcondition(alertOnClose, title='MACD ƒë·ªïi m√†u (ƒë√£ l·ªçc)', message='{"chat_id":"5978153872","text":"your text here"}')

