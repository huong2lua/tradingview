//@version=6
indicator(title="MACD 4C Pro", shorttitle="MACD4C_Pro")

// =====================
// 1) INPUTS
// =====================
fastMA   = input.int(12, title = 'Fast MA', minval = 1)
slowMA   = input.int(26, title = 'Slow MA', minval = 1)
sigMA    = input.int(9,  title = 'Signal MA', minval = 1)
atrLength = input.int(14, title = 'ATR Length', minval = 1)
chatId   = input.string("-1003256916567", title = "Telegram chat_id (optional)")

// ---------------------
// helper: timeframe label
// ---------------------
tfLabel() =>
    m = timeframe.multiplier
    timeframe.isseconds ? str.tostring(m) + "s" :
     timeframe.isminutes and m < 60 ? str.tostring(m) + "m" :
     timeframe.isminutes ? str.tostring(m/60) + "h" :
     timeframe.isdaily ? (m == 1 ? "1D" : str.tostring(m) + "D") :
     timeframe.isweekly ? (m == 1 ? "1W" : str.tostring(m) + "W") :
     timeframe.ismonthly ? (m == 1 ? "1M" : str.tostring(m) + "M") :
     timeframe.period

// =============================================
// 2) MACD + 4-color histogram
// =============================================
[macdLine, signalLine, _] = ta.macd(close, fastMA, slowMA, sigMA)
currMacd = macdLine
prevMacd = macdLine[1]

isUpStrong   = currMacd > 0 and currMacd > prevMacd
isUpWeak     = currMacd > 0 and currMacd <= prevMacd
isDownWeak   = currMacd <= 0 and currMacd >= prevMacd
isDownStrong = currMacd < 0 and currMacd < prevMacd

// Optimized ternary version (fastest execution)
plotColor = currMacd > 0 ? (currMacd > prevMacd ? color.new(color.rgb(0, 255, 0), 35) : color.new(color.rgb(0, 128, 0), 35))
                         : (currMacd < prevMacd ? color.new(color.rgb(128, 0, 0), 35) : color.new(color.rgb(255, 0, 0), 35))

plot(currMacd, style = plot.style_histogram, color = plotColor, linewidth = 3, title = 'MACD Histogram')
plot(0, title = 'Zero Line', linewidth = 1, color = color.gray)

// detect color change (for alert trigger)
colorChanged = (isUpStrong and not isUpStrong[1]) or
               (isUpWeak   and not isUpWeak[1])   or
               (isDownWeak and not isDownWeak[1]) or
               (isDownStrong and not isDownStrong[1])

// ==================================
// 3) SIGNALS
// ==================================
isBuySignal  = isUpStrong or isDownWeak
isSellSignal = isDownStrong or isUpWeak

// ==================================
// 4) ATR hiá»‡n táº¡i
// ==================================
atrValue = ta.atr(atrLength)

// =======================
// 5) ALERT + WEBHOOK JSON (NO TP/SL/LOT)
// =======================
alertOnClose  = colorChanged and barstate.isconfirmed

if alertOnClose
    // human-friendly labels
    trendType  = isUpStrong ? "mua máº¡nh ðŸŸ¢" : isUpWeak ? "mua yáº¿u ðŸ”µ" : isDownWeak ? "bÃ¡n yáº¿u ðŸŸ " : isDownStrong ? "bÃ¡n máº¡nh ðŸ”´" : "khÃ´ng xÃ¡c Ä‘á»‹nh â“"
    signalType = isBuySignal ? "BUY ðŸŸ©" : isSellSignal ? "SELL ðŸŸ¥" : "NO â“"

    // single-line message separated by â”‚, thÃªm OHLC + ATR
    msg = "#" + syminfo.ticker + " " + tfLabel() + " â”‚ " +
          trendType + " â”‚ " +
          signalType + " â”‚ " +
          "O: " + str.tostring(open,  format.mintick) + " â”‚ " +
          "H: " + str.tostring(high,  format.mintick) + " â”‚ " +
          "L: " + str.tostring(low,   format.mintick) + " â”‚ " +
          "C: " + str.tostring(close, format.mintick) + " â”‚ " +
          "ATR(" + str.tostring(atrLength) + "): " + str.tostring(atrValue, format.mintick)

    safeMsg = str.replace(msg, '"', '\\"')
    alertMessage = '{"chat_id":"' + chatId + '","text":"' + safeMsg + '"}'
    alert(alertMessage, freq = alert.freq_once_per_bar_close)

// End of script
