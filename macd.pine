//@version=6
indicator(title="MACD 4C Pro", shorttitle="MACD4C_Pro")

// =====================
// 1) INPUTS
// =====================
fastMA           = input.int(12,    title = 'Fast MA', minval = 1)
slowMA           = input.int(26,    title = 'Slow MA', minval = 1)
sigMA            = input.int(9,     title = 'Signal MA', minval = 1)
atrLength        = input.int(14,    title = 'ATR Length', minval = 1)
atrMult          = input.float(1.5, title = 'ATR Multiplier (for SL)', step = 0.1)
rrRatio          = input.float(2.0, title = 'Risk:Reward Ratio (TP/SL)', step = 0.1)
riskUSD          = input.float(20,  title = 'Risk per trade (USD)', step = 1.0)
swingLen         = input.int(9,     title = 'Swing length (lowest/highest) for SL', minval = 1)
tickValuePerLot  = input.float(0.1, title = 'Tick value per lot (USD/tick/lot)', step = 0.01, minval = 0.0001)
chatId           = input.string("-1003256916567", title = "Telegram chat_id (optional)")

// ---------------------
// helper: timeframe label
// ---------------------
tfLabel() =>
    m = timeframe.multiplier
    timeframe.isseconds ? str.tostring(m) + "s" :
     timeframe.isminutes and m < 60 ? str.tostring(m) + "m" :
     timeframe.isminutes ? str.tostring(m/60) + "h" :
     timeframe.isdaily ? (m == 1 ? "1D" : str.tostring(m) + "D") :
     timeframe.isweekly ? (m == 1 ? "1W" : str.tostring(m) + "W") :
     timeframe.ismonthly ? (m == 1 ? "1M" : str.tostring(m) + "M") :
     timeframe.period

// =============================================
// 2) MACD + 4-color histogram
// =============================================
[macdLine, signalLine, _] = ta.macd(close, fastMA, slowMA, sigMA)
currMacd = macdLine
prevMacd = macdLine[1]

isUpStrong   = currMacd > 0 and currMacd > prevMacd
isUpWeak     = currMacd > 0 and currMacd <= prevMacd
isDownWeak   = currMacd <= 0 and currMacd >= prevMacd
isDownStrong = currMacd < 0 and currMacd < prevMacd

// Optimized ternary version (fastest execution)
plotColor = currMacd > 0 ? (currMacd > prevMacd ? color.new(color.rgb(0, 255, 0), 35) : color.new(color.rgb(0, 128, 0), 35))
                         : (currMacd < prevMacd ? color.new(color.rgb(128, 0, 0), 35) : color.new(color.rgb(255, 0, 0), 35))

plot(currMacd, style = plot.style_histogram, color = plotColor, linewidth = 3, title = 'MACD Histogram')
plot(0, title = 'Zero Line', linewidth = 1, color = color.gray)

// detect color change (for alert trigger)
colorChanged = (isUpStrong and not isUpStrong[1]) or
               (isUpWeak   and not isUpWeak[1])   or
               (isDownWeak and not isDownWeak[1]) or
               (isDownStrong and not isDownStrong[1])

// ==================================
// 3) SIGNALS
// ==================================
isBuySignal  = isUpStrong or isDownWeak
isSellSignal = isDownStrong or isUpWeak

// ===============================
// 4) ATR, SL/TP and LOT calculation
// ===============================
atrValue   = ta.atr(atrLength)
lowestSw   = ta.lowest(low,  swingLen)
highestSw  = ta.highest(high, swingLen)
currPrice  = close

slBuy  = lowestSw  - atrValue * atrMult
slSell = highestSw + atrValue * atrMult

// TP is calculated from entry and SL distance * RR ratio
tpBuy  = currPrice + (currPrice - slBuy) * rrRatio
tpSell = currPrice - (slSell - currPrice) * rrRatio

slDistance = isBuySignal  ? (currPrice - slBuy)  :
             isSellSignal ? (slSell - currPrice) :
             na

ticksToSL = na(slDistance) ? na : slDistance / syminfo.mintick

// Lot sizing: round to step and enforce minimum
MIN_LOT  = 0.01
LOT_STEP = 0.01

lotRaw     = na(ticksToSL) or (ticksToSL <= 0) ? na : (riskUSD / (ticksToSL * tickValuePerLot))
lotRounded = na(lotRaw) ? na : math.round(lotRaw / LOT_STEP) * LOT_STEP
lotSize    = na(lotRounded) ? na : math.max(lotRounded, MIN_LOT)

// =======================
// 5) ALERT + WEBHOOK JSON
// =======================
alertOnClose  = colorChanged and barstate.isconfirmed

if alertOnClose
    // human-friendly labels
    trendType  = isUpStrong ? "mua máº¡nh ðŸŸ¢" : isUpWeak ? "mua yáº¿u ðŸ“ˆ" : isDownWeak ? "bÃ¡n yáº¿u ðŸŸ " : isDownStrong ? "bÃ¡n máº¡nh ðŸ”»" : "khÃ´ng xÃ¡c Ä‘á»‹nh â“"
    signalType = isBuySignal ? "BUY ðŸŸ©" : isSellSignal ? "SELL ðŸŸ¥" : "NO â“"

    slValue = isBuySignal ? slBuy : isSellSignal ? slSell : na
    tpValue = isBuySignal ? tpBuy : isSellSignal ? tpSell : na

    // single-line message separated by â”‚
    msg = "#" + syminfo.ticker + " " + tfLabel() + " â”‚ " +
          trendType + " â”‚ " +
          signalType + " â”‚ " +
          "Entry: " + str.tostring(currPrice, format.mintick) + " â”‚ " +
          "SL: "    + str.tostring(slValue,   format.mintick) + " â”‚ " +
          "TP: "    + str.tostring(tpValue,   format.mintick) + " â”‚ " +
          "Lot: "   + (na(lotSize) ? "n/a" : str.tostring(lotSize, "#.##"))

    safeMsg = str.replace(msg, '"', '\\"')
    alertMessage = '{"chat_id":"' + chatId + '","text":"' + safeMsg + '"}'
    alert(alertMessage, freq = alert.freq_once_per_bar_close)

// End of script
